# Raymarched Fractal Flythrough -- Design

## Overview

A new scene at `site/3d/scenes/raymarched-fractal/` that renders 3D fractals via GPU raymarching with a slow-moving flythrough camera. The user flies through infinite fractal geometry in a cockpit-style camera model, with extensive configurability for fractal type, visual style, quality, and flight parameters.

This is the first scene in the project to use true 3D raymarching -- the existing fractal-dreamscape is a 2D Julia set on a fullscreen quad.

## File Structure

```
site/3d/scenes/raymarched-fractal/
├── index.html           # Standard import map + canvas (same pattern as other scenes)
├── main.js              # Scene setup, settings, camera, animation loop
├── fractal.vert         # Passthrough vertex shader (fullscreen quad)
└── fractal.frag         # Raymarching engine + all DE functions + lighting
```

## Approach

Single mega-shader (`fractal.frag`) containing all fractal distance estimators, with uniform-based switching between them. Each DE is a self-contained function with clear separator comments and dependency notes to facilitate future extraction into separate shader files if the single file becomes unwieldy.

**Rationale:** Single shader compile, fast preset switching (just change uniforms), simpler file structure, all fractals share the same lighting/coloring pipeline. The alternative (separate `.frag` per fractal) would cause visible recompilation hitches on preset switch and require duplicating shared lighting code.

## Fractal Types

Four distance estimators, selectable via `uFractalType` int uniform:

- **Mandelbulb** -- Classic 3D Mandelbrot generalization. Bulbous, organic shapes with infinite surface detail. Configurable `Power` parameter.
- **Mandelbox** -- Box-fold fractal with cathedral-like architecture. Configurable `Fold Limit` and `Box Scale` parameters.
- **Menger Sponge** -- Recursive cube-based fractal with infinite holes. Clean geometric aesthetic.
- **Hybrid** -- Morphs between Mandelbulb and Mandelbox using `mix(DE_a(p), DE_b(p), t)` where `t` oscillates slowly over time via a `uMorphProgress` uniform. Configurable `Morph Speed`.

A router function dispatches to the selected DE:

```glsl
float DE(vec3 p) {
    if (uFractalType == 0) return DE_mandelbulb(p);
    if (uFractalType == 1) return DE_mandelbox(p);
    if (uFractalType == 2) return DE_menger(p);
    return DE_hybrid(p);
}
```

## Visual Styles

Four styles selectable via `uVisualStyle` int uniform. All share the same lighting pipeline -- the style adjusts weights and palette parameters:

- **Dark & Atmospheric** (default) -- Black background, exponential fog fading to black, edge glow, subtle ambient occlusion.
- **Psychedelic** -- Vivid IQ cosine palette cycling, bright interior glow, low fog.
- **Geometric** -- Monochrome base with configurable accent color. Sharp AO, no glow, clean edges.
- **Ambient** -- Soft pastel palette, gentle fog, low contrast. Screensaver mode.

### Lighting Pipeline (shared)

1. **Ambient Occlusion** -- from raymarching step count (more steps = deeper crevice = darker).
2. **Surface normal** -- central differences on DE (6 extra evaluations per hit).
3. **Fog** -- exponential distance fog, color and density vary by style.
4. **Edge glow** -- rays passing close to surface without hitting contribute glow, intensity varies by style.
5. **Color** -- IQ cosine palettes, each style has its own palette parameters.

## Quality Presets

Dropdown with four presets that auto-set iteration count and resolution scale:

| Preset | Max Iterations | Resolution Scale |
|--------|---------------|-----------------|
| Low    | ~40           | 0.25            |
| Medium | ~80           | 0.5             |
| High   | ~120          | 0.75            |
| Ultra  | ~200          | 1.0             |

Individual `Max Iterations` and `Resolution Scale` sliders are exposed so users can override the preset values.

## Camera System

Cockpit camera model with two separate orientations:

1. **Plane orientation** (direction of travel) -- controlled by keyboard, driven by autopilot when idle
2. **View orientation** (where the camera looks) -- plane orientation + mouse freelook offset

### Always

The plane moves forward along its own heading at a configurable speed.

### Keyboard (WASD / Arrow Keys)

- **Left/Right:** yaw + roll the plane (changes direction of travel)
- **Up/Down:** pitch the plane (changes direction of travel)
- Sensitivity configurable via sliders.

### Mouse Drag

Freelook only -- rotates the view relative to the plane's heading. No effect on flight path or direction of travel.

### Autopilot

Camera position follows a smooth 3D path generated by layered simplex noise from `lib/utils/noise.js`. Three noise channels (x, y, z) at different frequencies produce an organic wandering path. Forward direction is the path tangent. Camera roll oscillates gently for cinematic feel.

### Return to Autopilot

Wired to `ChromeController`'s `onIdle` callback:

1. **Freelook resets first** -- view smoothly lerps back to looking straight ahead (matching plane heading) over ~2 seconds.
2. **Plane heading returns to autopilot** -- on inactivity timeout, plane heading smoothly lerps back to the noise-driven path over ~2 seconds, then autopilot takes over fully.

## Settings Panel

### Fractal

| Setting       | Type     | Details                                         |
|---------------|----------|-------------------------------------------------|
| Fractal Type  | dropdown | Mandelbulb, Mandelbox, Menger Sponge, Hybrid    |
| Power         | slider   | Mandelbulb-specific, greyed out for others       |
| Fold/Scale    | slider   | Mandelbox-specific, greyed out for others        |
| Morph Speed   | slider   | Hybrid-specific, greyed out for others           |

### Visual

| Setting       | Type     | Details                                         |
|---------------|----------|-------------------------------------------------|
| Visual Style  | dropdown | Dark & Atmospheric, Psychedelic, Geometric, Ambient |
| AO Strength   | slider   |                                                 |
| Fog Density   | slider   |                                                 |
| Glow Intensity| slider   |                                                 |
| Brightness    | slider   |                                                 |
| Accent Color  | color    | Used by Geometric style, available to all        |

### Quality

| Setting          | Type     | Details                                      |
|------------------|----------|----------------------------------------------|
| Quality          | dropdown | Low, Medium, High, Ultra                      |
| Max Iterations   | slider   | Auto-set by quality preset, user can override |
| Resolution Scale | slider   | 0.25-1.0, auto-set by quality preset          |

### Flight

| Setting              | Type   | Details |
|----------------------|--------|---------|
| Speed                | slider |         |
| Yaw/Roll Sensitivity | slider |         |
| Pitch Sensitivity    | slider |         |

### Auto-Camera

| Setting          | Type   | Details                        |
|------------------|--------|--------------------------------|
| Auto-Camera      | toggle |                                |
| Inactivity (sec) | slider | Same pattern as every other scene |

## Shader Structure

```
fractal.frag (~450-500 lines)

// ============================================================
// Section: Uniforms & Constants
// ============================================================

// ============================================================
// Section: Utility Functions
// ============================================================
// rotation matrices, IQ cosine palette

// ============================================================
// DE: Mandelbulb
// Self-contained. Depends only on: uPower uniform, rotation utils
// ============================================================

// ============================================================
// DE: Mandelbox
// Self-contained. Depends only on: uFoldLimit, uBoxScale uniforms
// ============================================================

// ============================================================
// DE: Menger Sponge
// Self-contained. Depends only on: rotation utils
// ============================================================

// ============================================================
// DE: Hybrid (Mandelbulb + Mandelbox morph)
// Depends on: DE_mandelbulb, DE_mandelbox, uMorphProgress
// ============================================================

// ============================================================
// Section: DE Router
// ============================================================

// ============================================================
// Section: Raymarcher
// ============================================================

// ============================================================
// Section: Lighting & Coloring
// ============================================================
// estimateNormal, calcAO, getColor, shade

// ============================================================
// Section: Main
// ============================================================
// Build ray, march, shade, output
```

## Scene Integration

Follows the standard scene anatomy from ARCHITECTURE.md:

- `SceneManager` with `orbitControls: false`
- `SettingsPanel` with scene ID `'raymarched-fractal'`
- `ChromeController` wired to `onActive`/`onIdle` for autopilot toggle
- `AutoCamera` included for pattern consistency
- Fullscreen quad with raymarching shader material
- Animation loop updating uniforms each frame (`uTime`, `uCameraPos`, `uCameraDir`, `uCameraUp`)
- Link added to `site/index.html`
- Diagrams regenerated via `npm run diagrams`
- ARCHITECTURE.md updated with new scene description
